<!DOCTYPE html>
<html class="head">
    <head>
        <title id="Title">3STAT</title>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="style.css">
        <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
    </head>
    <body>
        <h1 id="NameOfDevice" class="NameOfDevice"></h1>
        <div class="main">
            <div class="center">
                <h2 id="NameOfD1" class="name"></h2>
                <button type="button" id="newD1" class="ChangeName">
                    <img src="picture\edit.png" alt="Image" width="25px" height="25px" >
                </button><br>
            </div> 
            <button type="button" id="StatOfD1" class="SW">開啟</button><br>
            <button type="button" id="TimeOnOfD1" class="Time">設定開啟時間</button>
            <button type="button" id="TimeOffOfD1" class="Time">設定關閉時間</button><br>
        </div>
        
        <br><br>
        <div class="main">
            <div class="center">
                <h2 id="NameOfD2" class="name"></h2>
                <button type="button" id="newD2" class="ChangeName">
                    <img src="picture\edit.png" alt="Image" width="25px" height="25px" >
                </button><br>
            </div>
            <button type="button" id="StatOfD2" class="SW">開啟</button><br>
            <button type="button" id="TimeOnOfD2" class="Time">設定開啟時間</button>
            <button type="button" id="TimeOffOfD2" class="Time">設定關閉時間</button><br>
        </div>
        
        <br><br>
        <div class="main">
            <div class="center">
                <h2 id="NameOfD3" class="name"></h2>
                <button type="button" id="newD3" class="ChangeName">
                    <img src="picture\edit.png" alt="Image" width="25px" height="25px" >
                </button><br>
            </div>
            <button type="button" id="StatOfD3" class="SW">開啟</button><br>
            <button type="button" id="TimeOnOfD3" class="Time">設定開啟時間</button>
            <button type="button" id="TimeOffOfD3" class="Time">設定關閉時間</button><br>
            
        </div>
        <br><br><br>
        <div class="goBackDevicePage">
            <a href="devicepage.html">
                <button type="button" id="back" class="Time">回到裝置頁</button><br>
            </a>
        </div>
        

        <dialog id="nameD1">
            <h1>請輸入新的裝置名稱</h1>
            <p id="D1name"></p>
            <input id="D1newName">
            <button id="D1confirm">確認</button>
            <button onclick="nameD1.close()">取消</button>
        </dialog>
        <dialog id="nameD2">
            <h1>請輸入新的裝置名稱</h1>
            <p id="D2name"></p>
            <input id="D2newName">
            <button id="D2confirm">確認</button>
            <button onclick="nameD2.close()">取消</button>
        </dialog>
        <dialog id="nameD3">
            <h1>請輸入新的裝置名稱</h1>
            <p id="D3name"></p>
            <input id="D3newName">
            <button id="D3confirm">確認</button>
            <button onclick="nameD3.close()">取消</button>
        </dialog>

        <dialog id="TOD1Check">
            <h1>是否更改開啟時間?</h1>
            <button id="TOD1confirm">確認</button>
            <button onclick="TOD1Check.close()">取消</button>
        </dialog>
        <dialog id="TOD2Check">
            <h1>是否更改開啟時間?</h1>
            <button id="TOD2confirm">確認</button>
            <button onclick="TOD2Check.close()">取消</button>
        </dialog>
        <dialog id="TOD3Check">
            <h1>是否更改開啟時間?</h1>
            <button id="TOD3confirm">確認</button>
            <button onclick="TOD3Check.close()">取消</button>
        </dialog>

        <dialog id="TOD1Set">
            <h1>設定開啟時間</h1>
            <input id="TOD1hr" type="number" min="0" max="23">
            時 : 
            <input id="TOD1min" type="number" min="0" max="59">
            分
            <button id="TOD1Setconfirm">確認</button>
            <button onclick="TOD1Set.close()">取消</button>
        </dialog>
        <dialog id="TOD2Set">
            <h1>設定開啟時間?</h1>
            <input id="TOD2hr" type="number" min="0" max="23">
            時 : 
            <input id="TOD2min" type="number" min="0" max="59">
            分
            <button id="TOD2Setconfirm">確認</button>
            <button onclick="TOD2Set.close()">取消</button>
        </dialog>
        <dialog id="TOD3Set">
            <h1>設定開啟時間?</h1>
            <input id="TOD3hr" type="number" min="0" max="23">
            時 : 
            <input id="TOD3min" type="number" min="0" max="59">
            分
            <button id="TOD3Setconfirm">確認</button>
            <button onclick="TOD3Set.close()">取消</button>
        </dialog>

        <dialog id="TCD1Check">
            <h1>是否更改關閉時間?</h1>
            <button id="TCD1confirm">確認</button>
            <button onclick="TCD1Check.close()">取消</button>
        </dialog>
        <dialog id="TCD2Check">
            <h1>是否更改關閉時間?</h1>
            <button id="TCD2confirm">確認</button>
            <button onclick="TCD2Check.close()">取消</button>
        </dialog>
        <dialog id="TCD3Check">
            <h1>是否更改關閉時間?</h1>
            <button id="TCD3confirm">確認</button>
            <button onclick="TCD3Check.close()">取消</button>
        </dialog>

        <dialog id="TCD1Set">
            <h1>設定關閉時間</h1>
            <input id="TCD1hr" type="number" min="0" max="23">
            時 : 
            <input id="TCD1min" type="number" min="0" max="59">
            分
            <button id="TCD1Setconfirm">確認</button>
            <button onclick="TCD1Set.close()">取消</button>
        </dialog>
        <dialog id="TCD2Set">
            <h1>設定關閉時間?</h1>
            <input id="TCD2hr" type="number" min="0" max="23">
            時 : 
            <input id="TCD2min" type="number" min="0" max="59">
            分
            <button id="TCD2Setconfirm">確認</button>
            <button onclick="TCD2Set.close()">取消</button>
        </dialog>
        <dialog id="TCD3Set">
            <h1>設定關閉時間?</h1>
            <input id="TCD3hr" type="number" min="0" max="23">
            時 : 
            <input id="TCD3min" type="number" min="0" max="59">
            分
            <button id="TCD3Setconfirm">確認</button>
            <button onclick="TCD3Set.close()">取消</button>
        </dialog>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";

            const firebaseConfig = {
              apiKey: "AIzaSyAF4OdtYUAomk_4WnvE5MXb_nphlQ33UyA",
              authDomain: "esp8266-ai2.firebaseapp.com",
              databaseURL: "https://esp8266-ai2-default-rtdb.firebaseio.com",
              projectId: "esp8266-ai2",
              storageBucket: "esp8266-ai2.appspot.com",
              messagingSenderId: "245671703015",
              appId: "1:245671703015:web:28612316e5ec39dd6bcd42"
            };

            const app = initializeApp(firebaseConfig);
            import { getDatabase, set, get, update, remove, ref, onValue } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";
            const db = getDatabase();

            const deviceName = Cookies.get('device');
            var NameOfDevice = document.querySelector('#NameOfDevice')
            var MAC = deviceName.split(",")[1]
            const getD1 = ref(db, MAC + '/D1')
            const getD2 = ref(db, MAC + '/D2')
            const getD3 = ref(db, MAC + '/D3')

            const getD1OT = ref(db, MAC + '/OT/D1')
            const getD2OT = ref(db, MAC + '/OT/D2')
            const getD3OT = ref(db, MAC + '/OT/D3')

            const getD1CT = ref(db, MAC + '/CT/D1')
            const getD2CT = ref(db, MAC + '/CT/D2')
            const getD3CT = ref(db, MAC + '/CT/D3')

            var NameOfD1 = document.querySelector('#NameOfD1')
            var NameOfD2 = document.querySelector('#NameOfD2')
            var NameOfD3 = document.querySelector('#NameOfD3')
            var StatOfD1 = document.querySelector('#StatOfD1')
            var StatOfD2 = document.querySelector('#StatOfD2')
            var StatOfD3 = document.querySelector('#StatOfD3')
            var D1name = document.querySelector('#D1name')
            var D2name = document.querySelector('#D2name')
            var D3name = document.querySelector('#D3name')
            var nameD1 = document.querySelector('#nameD1')
            var nameD2 = document.querySelector('#nameD2')
            var nameD3 = document.querySelector('#nameD3')
            var TimeOnOfD1 = document.querySelector('#TimeOnOfD1')
            var TimeOnOfD2 = document.querySelector('#TimeOnOfD2')
            var TimeOnOfD3 = document.querySelector('#TimeOnOfD3')
            var TimeOffOfD1 = document.querySelector('#TimeOffOfD1')
            var TimeOffOfD2 = document.querySelector('#TimeOffOfD2')
            var TimeOffOfD3 = document.querySelector('#TimeOffOfD3')
            var TOD1Check = document.querySelector('#TOD1Check')
            var TOD2Check = document.querySelector('#TOD2Check')
            var TOD3Check = document.querySelector('#TOD3Check')
            var TCD1Check = document.querySelector('#TCD1Check')
            var TCD2Check = document.querySelector('#TCD2Check')
            var TCD3Check = document.querySelector('#TCD3Check')
            var TOD1Set = document.querySelector('#TOD1Set')
            var TOD2Set = document.querySelector('#TOD2Set')
            var TOD3Set = document.querySelector('#TOD3Set')
            var TCD1Set = document.querySelector('#TCD1Set')
            var TCD2Set = document.querySelector('#TCD2Set')
            var TCD3Set = document.querySelector('#TCD3Set')
            var TOD1confirm = document.querySelector('#TOD1confirm')
            var TOD2confirm = document.querySelector('#TOD2confirm')
            var TOD3confirm = document.querySelector('#TOD3confirm')
            var TCD1confirm = document.querySelector('#TCD1confirm')
            var TCD2confirm = document.querySelector('#TCD2confirm')
            var TCD3confirm = document.querySelector('#TCD3confirm')
            var TOD1Setconfirm = document.querySelector('#TOD1Setconfirm')
            var TOD2Setconfirm = document.querySelector('#TOD2Setconfirm')
            var TOD3Setconfirm = document.querySelector('#TOD3Setconfirm')
            var TCD1Setconfirm = document.querySelector('#TCD1Setconfirm')
            var TCD2Setconfirm = document.querySelector('#TCD2Setconfirm')
            var TCD3Setconfirm = document.querySelector('#TCD3Setconfirm')
            var TOD1hr = document.querySelector('#TOD1hr')
            var TOD2hr = document.querySelector('#TOD2hr')
            var TOD3hr = document.querySelector('#TOD3hr')
            var TOD1min = document.querySelector('#TOD1min')
            var TOD2min = document.querySelector('#TOD2min')
            var TOD3min = document.querySelector('#TOD3min')
            var TCD1hr = document.querySelector('#TCD1hr')
            var TCD2hr = document.querySelector('#TCD2hr')
            var TCD3hr = document.querySelector('#TCD3hr')
            var TCD1min = document.querySelector('#TCD1min')
            var TCD2min = document.querySelector('#TCD2min')
            var TCD3min = document.querySelector('#TCD3min')

            NameOfDevice.innerHTML = deviceName.split(",")[0]
            NameOfD1.innerHTML = deviceName.split(",")[3]
            NameOfD2.innerHTML = deviceName.split(",")[4]
            NameOfD3.innerHTML = deviceName.split(",")[5]

            onValue(getD1, (snapshot) => {
                var StatOfD1 = document.querySelector('#StatOfD1')
                if (snapshot.val() == '0'){
                    StatOfD1.innerHTML = '關閉'
                }else{
                    StatOfD1.innerHTML = '開啟'
                }
            })
            onValue(getD2, (snapshot) => {
                var StatOfD2 = document.querySelector('#StatOfD2')
                if (snapshot.val() == '0'){
                    StatOfD2.innerHTML = '關閉'
                }else{
                    StatOfD2.innerHTML = '開啟'
                }
            })
            onValue(getD3, (snapshot) => {
                var StatOfD3 = document.querySelector('#StatOfD3')
                if (snapshot.val() == '0'){
                    StatOfD3.innerHTML = '關閉'
                }else{
                    StatOfD3.innerHTML = '開啟'
                }
            })

            onValue(getD1OT, (snapshot) => {
                var TimeOnOfD1 = document.querySelector('#TimeOnOfD1')
                if (snapshot.val() == '0'){
                    TimeOnOfD1.innerHTML = '設定開啟時間'
                }else{
                    TimeOnOfD1.innerHTML = '已設定' + snapshot.val().replace('"', "").replace('"', "") + '開啟'
                }
            })
            onValue(getD2OT, (snapshot) => {
                var TimeOnOfD2 = document.querySelector('#TimeOnOfD2')
                if (snapshot.val() == '0'){
                    TimeOnOfD2.innerHTML = '設定開啟時間'
                }else{
                    TimeOnOfD2.innerHTML = '已設定' + snapshot.val().replace('"', "").replace('"', "") + '開啟'
                }
            })
            onValue(getD3OT, (snapshot) => {
                var TimeOnOfD3 = document.querySelector('#TimeOnOfD3')
                if (snapshot.val() == '0'){
                    TimeOnOfD3.innerHTML = '設定開啟時間'
                }else{
                    TimeOnOfD3.innerHTML = '已設定' + snapshot.val().replace('"', "").replace('"', "") + '開啟'
                }
            })

            onValue(getD1CT, (snapshot) => {
                var TimeOffOfD1 = document.querySelector('#TimeOffOfD1')
                if (snapshot.val() == '0'){
                    TimeOffOfD1.innerHTML = '設定關閉時間'
                }else{
                    TimeOffOfD1.innerHTML = '已設定' + snapshot.val().replace('"', "").replace('"', "") + '關閉'
                }
            })
            onValue(getD2CT, (snapshot) => {
                var TimeOffOfD2 = document.querySelector('#TimeOffOfD2')
                if (snapshot.val() == '0'){
                    TimeOffOfD2.innerHTML = '設定關閉時間'
                }else{
                    TimeOffOfD2.innerHTML = '已設定' + snapshot.val().replace('"', "").replace('"', "") + '關閉'
                }
            })
            onValue(getD3CT, (snapshot) => {
                var TimeOffOfD3 = document.querySelector('#TimeOffOfD3')
                if (snapshot.val() == '0'){
                    TimeOffOfD3.innerHTML = '設定關閉時間'
                }else{
                    TimeOffOfD3.innerHTML = '已設定' + snapshot.val().replace('"', "").replace('"', "") + '關閉'
                }
            })

            function ChangeD1(){
                if(StatOfD1.innerHTML == '關閉'){
                    StatOfD1.innerHTML = '開啟'
                    update(ref(db, MAC),{
                        D1: 1
                    })
                }else if(StatOfD1.innerHTML == '開啟'){
                    StatOfD1.innerHTML = '關閉'
                    update(ref(db, MAC),{
                        D1: 0
                    })
                }
            }
            function ChangeD2(){
                if(StatOfD2.innerHTML == '關閉'){
                    StatOfD2.innerHTML = '開啟'
                    update(ref(db, MAC),{
                        D2: 1
                    })
                }else if(StatOfD2.innerHTML == '開啟'){
                    StatOfD2.innerHTML = '關閉'
                    update(ref(db, MAC),{
                        D2: 0
                    })
                }
            }
            function ChangeD3(){
                if(StatOfD3.innerHTML == '關閉'){
                    StatOfD3.innerHTML = '開啟'
                    update(ref(db, MAC),{
                        D3: 1
                    })
                }else if(StatOfD3.innerHTML == '開啟'){
                    StatOfD3.innerHTML = '關閉'
                    update(ref(db, MAC),{
                        D3: 0
                    })
                }
            }

            function AskD1OT(){
                if(TimeOnOfD1.innerHTML == '設定開啟時間'){
                    TOD1Set.showModal()
                }else{
                    TOD1Check.showModal()
                }
            }
            function AskD2OT(){
                if(TimeOnOfD2.innerHTML == '設定開啟時間'){
                    TOD2Set.showModal()
                }else{
                    TOD2Check.showModal()
                }
            }
            function AskD3OT(){
                if(TimeOnOfD3.innerHTML == '設定開啟時間'){
                    TOD3Set.showModal()
                }else{
                    TOD3Check.showModal()
                }
            }

            function ResetD1OT(){
                update(ref(db, MAC + '/OT'),{
                    D1: 0
                })
                TOD1Check.close()
            }
            function ResetD2OT(){
                update(ref(db, MAC + '/OT'),{
                    D2: 0
                })
                TOD2Check.close()
            }
            function ResetD3OT(){
                update(ref(db, MAC + '/OT'),{
                    D3: 0
                })
                TOD3Check.close()
            }

            function SetD1OT(){
                if (TOD1hr.value <= 9 && TOD1min.value <= 9){
                    var time = '"0' + TOD1hr.value + ":0" + TOD1min.value + '"'
                }else if(TOD1hr.value <= 9){
                    var time = '"0' + TOD1hr.value + ":" + TOD1min.value + '"'
                }else if(TOD1min.value <= 9){
                    var time = '"' + TOD1hr.value + ":0" + TOD1min.value + '"'
                }else{
                    var time = '"' + TOD1hr.value + ":" + TOD1min.value + '"'
                }
                update(ref(db, MAC + '/OT'),{
                    D1: time
                })
                TOD1Set.close()
            }
            function SetD2OT(){
                if (TOD2hr.value <= 9 && TOD2min.value <= 9){
                    var time = '"0' + TOD2hr.value + ":0" + TOD2min.value + '"'
                }else if(TOD2hr.value <= 9){
                    var time = '"0' + TOD2hr.value + ":" + TOD2min.value + '"'
                }else if(TOD2min.value <= 9){
                    var time = '"' + TOD2hr.value + ":0" + TOD2min.value + '"'
                }else{
                    var time = '"' + TOD2hr.value + ":" + TOD2min.value + '"'
                }
                update(ref(db, MAC + '/OT'),{
                    D2: time
                })
                TOD2Set.close()
            }
            function SetD3OT(){
                if (TOD3hr.value <= 9 && TOD3min.value <= 9){
                    var time = '"0' + TOD3hr.value + ":0" + TOD3min.value + '"'
                }else if(TOD3hr.value <= 9){
                    var time = '"0' + TOD3hr.value + ":" + TOD3min.value + '"'
                }else if(TOD3min.value <= 9){
                    var time = '"' + TOD3hr.value + ":0" + TOD3min.value + '"'
                }else{
                    var time = '"' + TOD3hr.value + ":" + TOD3min.value + '"'
                }
                update(ref(db, MAC + '/OT'),{
                    D3: time
                })
                TOD3Set.close()
            }

            function AskD1CT(){
                if(TimeOffOfD1.innerHTML == '設定關閉時間'){
                    TCD1Set.showModal()
                }else{
                    TCD1Check.showModal()
                }
            }
            function AskD2CT(){
                if(TimeOffOfD2.innerHTML == '設定關閉時間'){
                    TCD2Set.showModal()
                }else{
                    TCD2Check.showModal()
                }
            }
            function AskD3CT(){
                if(TimeOffOfD3.innerHTML == '設定關閉時間'){
                    TCD3Set.showModal()
                }else{
                    TCD3Check.showModal()
                }
            }

            function ResetD1CT(){
                update(ref(db, MAC + '/CT'),{
                    D1: 0
                })
                TCD1Check.close()
            }
            function ResetD2CT(){
                update(ref(db, MAC + '/CT'),{
                    D2: 0
                })
                TCD2Check.close()
            }
            function ResetD3CT(){
                update(ref(db, MAC + '/CT'),{
                    D3: 0
                })
                TCD3Check.close()
            }

            function SetD1CT(){
                if (TCD1hr.value <= 9 && TCD1min.value <= 9){
                    var time = '"0' + TCD1hr.value + ":0" + TCD1min.value + '"'
                }else if(TCD1hr.value <= 9){
                    var time = '"0' + TCD1hr.value + ":" + TCD1min.value + '"'
                }else if(TCD1min.value <= 9){
                    var time = '"' + TCD1hr.value + ":0" + TCD1min.value + '"'
                }else{
                    var time = '"' + TCD1hr.value + ":" + TCD1min.value + '"'
                }
                update(ref(db, MAC + '/CT'),{
                    D1: time
                })
                TCD1Set.close()
            }
            function SetD2CT(){
                if (TCD2hr.value <= 9 && TCD2min.value <= 9){
                    var time = '"0' + TCD2hr.value + ":0" + TCD2min.value + '"'
                }else if(TCD2hr.value <= 9){
                    var time = '"0' + TCD2hr.value + ":" + TCD2min.value + '"'
                }else if(TCD2min.value <= 9){
                    var time = '"' + TCD2hr.value + ":0" + TCD2min.value + '"'
                }else{
                    var time = '"' + TCD2hr.value + ":" + TCD2min.value + '"'
                }
                update(ref(db, MAC + '/CT'),{
                    D2: time
                })
                TCD2Set.close()
            }
            function SetD3CT(){
                if (TCD3hr.value <= 9 && TCD3min.value <= 9){
                    var time = '"0' + TCD3hr.value + ":0" + TCD3min.value + '"'
                }else if(TCD3hr.value <= 9){
                    var time = '"0' + TCD3hr.value + ":" + TCD3min.value + '"'
                }else if(TCD3min.value <= 9){
                    var time = '"' + TCD3hr.value + ":0" + TCD3min.value + '"'
                }else{
                    var time = '"' + TCD3hr.value + ":" + TCD3min.value + '"'
                }
                update(ref(db, MAC + '/CT'),{
                    D3: time
                })
                TCD3Set.close()
            }

            function ChangeD1Name(){
                nameD1.showModal()
                D1name.innerHTML = '原本的裝置名稱：' + NameOfD1.innerHTML
            }
            function ChangeD2Name(){
                nameD2.showModal()
                D2name.innerHTML = '原本的裝置名稱：' + NameOfD2.innerHTML
            }
            function ChangeD3Name(){
                nameD3.showModal()
                D3name.innerHTML = '原本的裝置名稱：' + NameOfD3.innerHTML
            }

            StatOfD1.addEventListener('click', ChangeD1)
            StatOfD2.addEventListener('click', ChangeD2)
            StatOfD3.addEventListener('click', ChangeD3)

            newD1.addEventListener('click', ChangeD1Name)
            newD2.addEventListener('click', ChangeD2Name)
            newD3.addEventListener('click', ChangeD3Name)

            TimeOnOfD1.addEventListener('click', AskD1OT)
            TimeOnOfD2.addEventListener('click', AskD2OT)
            TimeOnOfD3.addEventListener('click', AskD3OT)
            TimeOffOfD1.addEventListener('click', AskD1CT)
            TimeOffOfD2.addEventListener('click', AskD2CT)
            TimeOffOfD3.addEventListener('click', AskD3CT)

            TOD1confirm.addEventListener('click', ResetD1OT)
            TOD2confirm.addEventListener('click', ResetD2OT)
            TOD3confirm.addEventListener('click', ResetD3OT)
            TCD1confirm.addEventListener('click', ResetD1CT)
            TCD2confirm.addEventListener('click', ResetD2CT)
            TCD3confirm.addEventListener('click', ResetD3CT)

            TOD1Setconfirm.addEventListener('click', SetD1OT)
            TOD2Setconfirm.addEventListener('click', SetD2OT)
            TOD3Setconfirm.addEventListener('click', SetD3OT)
            TCD1Setconfirm.addEventListener('click', SetD1CT)
            TCD2Setconfirm.addEventListener('click', SetD2CT)
            TCD3Setconfirm.addEventListener('click', SetD3CT)

        </script>

    </body>
</html>